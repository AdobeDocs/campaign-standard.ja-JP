---
solution: Campaign Standard
product: campaign
title: SMSのトラブルシューティング
description: SMSのトラブルシューティング
audience: administration
content-type: reference
topic-tags: configuring-channels
translation-type: tm+mt
source-git-commit: 80e4f752a1b9b6c8b0125a502c05c19796e98104
workflow-type: tm+mt
source-wordcount: '2696'
ht-degree: 0%

---


# SMSトラブルシューティング{#sms-troubleshooting}

## 異なる外部アカウント間の競合{#external-account-conflict}

インスタンスに複数のSMS外部アカウントがある場合は、外部アカウント間の競合が原因で問題が発生していないことを確認する必要があります。

Adobe Campaignは、外部アカウントを無関係なエンティティとして扱います。

複数のアカウントがある場合は、次の手順に従って問題を引き起こす外部アカウントを分離します。

1. すべての外部アカウントを無効にします。
1. 1つの外部アカウントを有効にします。
1. 問題を再現してみてください。
1. 最初の問題が必ずしも表示されない場合は、終了前に適切な回数の試行を行います。
1. そのアカウントで問題が発生しない場合は、そのアカウントを無効にし、次のアカウントでステップ2に戻ります。

各アカウントを個別にチェックすると、次の2つのシナリオが考えられます。

* **その問題は1つまたは複数のアカウントで発生した**

   この場合、各アカウントに別々にその他のトラブルシューティング手順を適用できます。 ネットワークトラフィックとログ数を減らすために、アカウントの診断時に他のアカウントを無効にすることをお勧めします。

* **1つのアカウントしかアクティブでない場合に問題が表示されませんでした**

   アカウント間で競合が発生しています。 前述したように、Adobe Campaignはアカウントを個別に扱いますが、プロバイダはアカウントを単一のアカウントとして扱うことができます。

   * すべてのアカウント間で異なるログイン/パスワードの組み合わせを使用している。
プロバイダーに連絡して、側の競合の可能性を診断する必要があります。

   * 一部の外部アカウントは、同じログイン/パスワードの組み合わせを共有します。
プロバイダは、`BIND PDU`がどの外部アカウントから来たかを知る手段がないので、複数のアカウントからの接続をすべて1つとして扱います。 2つのアカウントに対してランダムにMOとSRをルーティングし、問題を引き起こしている可能性があります。
プロバイダが同じログイン/パスワードの組み合わせで複数の短いコードをサポートしている場合は、`BIND PDU`のどこに短いコードを置くかを尋ねる必要があります。 ルーティングMOを正しく認めるのは`BIND PDU`だけなので、この情報は`BIND PDU`の中に入れる必要があり、`SUBMIT_SM`の中に入れる必要はありません。
[`BIND PDU`で使用できるフィールドは&lt;a0/>](../../administration/using/sms-protocol.md#information-pdu)の&lt;a0/>の各種PDU&lt;a1/>の情報を参照してください。通常は`address_range`に短いコードを追加しますが、プロバイダの特別なサポートが必要です。 複数の短縮コードを個別にルーティングする方法については、担当者にお問い合わせください。
Adobe Campaignは、同じ外部アカウントでの複数の短縮コードの処理をサポートしています。

## 一般的な外部アカウントの問題{#external-account-issues}

* コネクタが最近変更されたかどうか、およびどのユーザによって変更されたかを調べます(外部アカウントをグループとして確認します)。

   ```
   select saccount, (sserver ||':'||sport) as serverPort, iextaccountid, CASE WHEN N0.iactive=1 THEN 'Yes' ELSE 'No' END as "(x) Enabled",
   
   (select X1.sname from xtkoperator X1 where N0.icreatedbyid = X1.ioperatorid) as "Created By",
   
   (select X1.sname from xtkoperator X1 where N0.imodifiedbyid = X1.ioperatorid) as "Last Modified By",
   
   N0.slabel as "External Account", N0.tslastmodified as "LastModifiedDate"
   
   from nmsextaccount N0 LEFT JOIN xtkoperator X0 ON (N0.icreatedbyid=X0.ioperatorid) order by 8 DESC LIMIT 50;
   ```

* システムがアップグレードされたかどうか、およびシステムがアップグレードされたタイミングを調べます（/postupgradeディレクトリ内）。
* SMSに影響を与えるパッケージが最近アップグレードされた可能性があるかどうかを調べます(/var/log/dpkg.log)。

## プロバイダー{#issue-provider}に接続する際の問題

* `BIND PDU`がゼロ以外の`command_status`コードを返す場合は、プロバイダに詳細を問い合わせてください。

* プロバイダーへのTCP接続を確立できるように、ネットワークが正しく構成されていることを確認してください。

* プロバイダーに、Adobe Campaignインスタンスの許可リストにIPが正しく追加されたかどうかを確認するように依頼します。

* **外部アカウント**&#x200B;の設定を確認します。 フィールドの値をプロバイダに問い合わせます。

* 接続が成功したが不安定な場合は、[不安定な接続の問題](../../administration/using/troubleshooting-sms.md#issues-unstable-connection)の節を確認してください。

* 接続の問題を診断するのが困難な場合、ネットワークキャプチャが情報を提供する可能性があります。 ネットワークのキャプチャを同時に実行しながら、問題が発生した場合は効率的に分析できるようにします。 また、問題が発生した正確な時刻もメモしておく必要があります。

## 不安定な接続に関する問題{#issues-unstable-connection}

次のいずれかが発生した場合、接続が不安定であると見なされます。

* MTAを再起動すると、一時的に問題が修正されます。 これは、接続が不安定な場合に、Adobe Campaign StandardでMTAスロットリングがトリガーされ、MTAを再起動するとスロットリングがクリアされることを意味します。 原因が見つかるまで、再び発生します。

* プロバイダは`UNBIND PDU`sを送信します。

* `enquire_link` タイムアウトします。Adobe Campaign側またはプロバイダー側でタイムアウトします。この場合、`ENQUIRE_LINK_RESP`にはゼロ以外のエラーコードが表示されます。

* `BIND PDU`がたくさんあります。接続数によっては、1日の間に数回を超えることはできません。 1時間に1つ以上のBIND PDUに警告を発する必要があります。

接続の安定性の問題を解決する方法：

* 不安定な接続が根本的な原因になることはほとんどありません。多くの場合、接続解除をトリガーする別の問題の結果です。 根本原因の検索が優先されます。

* 詳細SMPPトレースを有効にします。 接続が再開されたときに何が起きているかを確認するには、ユーザーが必要になります。

* プロバイダが`BIND PDU`を送信した場合は、何か問題がある可能性があります。 `UNBING`が送られる理由をプロバイダに問い合わせてください。

* ネットワークのキャプチャを行うことが、接続が閉じられた状態を確認する唯一の方法である場合があります。

* プロバイダが`TCP FIN`または`TCP RST`パケットを送信して接続を閉じた場合は、プロバイダに問い合わせてください。

* エラーコードを使用して`DELIVER_SM_RESP`などのクリーンエラーを送信した後、プロバイダーが接続を閉じた場合、コネクタを修正する必要があります。そうしないと、他の種類のメッセージが送信されず、MTAスロットリングがトリガーされます。 これは、接続を閉じるとMTとSRの両方に影響を与えるトランシーバモードで特に重要です。

## MT（エンドユーザに送信される通常のSMS）{#issue-MT}の送信時の問題

* 接続が安定していることを確認します。 SMPP接続は、1時間以上継続的に起動し続ける必要があります。 [不安定な接続に関する問題](../../administration/using/troubleshooting-sms.md#issues-unstable-connection)を参照してください。

* MTAを再起動すると、MTが再び送信され、しばらくの間作業が行われる場合、接続が不安定なためスロットリングが発生する可能性があります。 [不安定な接続に関する問題](../../administration/using/troubleshooting-sms.md#issues-unstable-connection)を参照してください。

* 部分一致のログが存在し、正しいステータスで正しい日付になっていることを確認します。 そうでない場合は、配信または配信の準備に関する問題が発生する可能性があります。

* MTAが実際にメッセージを処理していることを確認します。 そうでない場合は、SMSの問題ではない可能性があります。

* SMSコネクタがプロバイダの機器に実際にバインドされていることを確認します。 すべてのシステムが正しく通信されていることを確認するために、プロバイダにフィードバックを求めます。 バインド処理の詳細は`BIND_TRANSMITTER`と`BIND_TRANSCEIVER PDU`を参照してください。 適切なトラブルシューティングを行うために、SMPPトレースを有効にする必要がある場合があります。

* SMPPトレースを有効にして、`SUBMIT_SM PDU`に正しい情報が含まれていることを確認します。

* プロバイダーが「OK」値（コード0）で`SUBMIT_SM_RESP PDU`に応答していることを確認します。 PDUが適切な遅延で到着することを確認します。1秒を超える場合はプロバイダと話し合う必要があり、通常は100ミリ秒未満で到達します。

* これらの手順がすべて機能する場合は、問題がプロバイダ側にあることを確認できます。 プラットフォームのトラブルシューティングを行う必要があります。

* 動作してもスループットが異なる場合は、送信ウィンドウを調整し、MTスループットを下げてみてください。 それを調整するには、プロバイダと協力する必要があります。 Adobe Campaignは非常に速くメッセージを送信できるので、プロバイダの機器でパフォーマンスの問題が発生する可能性があります。

## MTは複製される（同じSMSが1行に複数回送信される）{#duplicated-MT}

重複は多くの場合、再試行が原因で発生します。 メッセージを再試行する際に重複が発生するのは普通です。再試行の根本原因を取り除く代わりに、

* 重複が60秒の間に送られるのを見た場合、おそらくプロバイダ側の問題だと思われますが、`SUBMIT_SM_RESP`を速く送るのに十分ではありません。

* `BIND/UNBIND`を多く見ると、不安定なつながりを持ちます。 重複メッセージの問題を解決する前に、[不安定な接続の問題](../../administration/using/troubleshooting-sms.md#issues-unstable-connection)の節を参照してください。

再試行時の重複量の低下：

* 送信ウィンドウを下げます。 送信側のウィンドウは、`SUBMIT_SM_RESP`待ち時間をカバーできる大きさにする必要があります。 この値は、ウィンドウがいっぱいの場合にエラーが発生した場合に複製できるメッセージの最大数を表します。

## SR (配信受信)を処理する際の問題{#issue-process-SR}

* SRのトラブルシューティングを行うには、SMPPトレースを有効にする必要があります。

* `DELIVER_SM PDU`がプロバイダーから来ていて、正しい形式であることを確認します。

* Adobe Campaignが`DELIVER_SM_RESP PDU`に正常に応答したことをタイムリーに確認します。 Adobe Campaign Standardでは、処理ロジック全体が適用されていることが保証されます。そうでない場合、処理が失敗した理由を示すエラーメッセージがログに記録されます。

`DELIVER_SM PDU`が正しく認識されない場合は、次の点を確認する必要があります。

* **外部アカウント**&#x200B;のID抽出とエラー処理に関連するregexをチェックします。 場合によっては、`DELIVER_SM PDU`の内容に対してこれらを検証する必要があります。

* `broadLogMsg`テーブルで、エラーが適切にプロビジョニングされていることを確認します。

* Adobe Campaign Standardの場合は、`broadLog`テーブルと`broadLogExec`テーブルが正しく同期されていることを確認してください。

無効なSR以外のすべてを修正しても、プロバイダのバッファ内に残っている場合は、**無効なID確認カウント**&#x200B;オプションを使用してスキップできます。 これは注意して使用し、バッファがクリーンになった後、できるだけ早く0にリセットする必要があります。

## MO（およびブラックリスト/自動応答）{#issue-process-MO}を処理する際の問題

* テスト中にSMPPトレースを有効にします。 TLSを有効にしない場合は、MOのトラブルシューティング時にネットワーク・キャプチャを実行し、PDUに正しい情報が含まれ、正しくフォーマットされていることを確認する必要があります。

* ネットワークトラフィックを捕捉したり、SMPPトレースを分析する場合、応答が設定されている場合は、MOとその応答MTとの会話全体を捕捉してください。

* MO (`DELIVER_SM PDU`)がトレースに表示されない場合は、プロバイダ側に問題があります。 プラットフォームのトラブルシューティングを行う必要があります。

* `DELIVER_SM PDU`が表示された場合は、Adobe Campaignが`DELIVER_SM_RESP PDU`に成功したことを確認してください（コード0）。 このRESPは、すべての処理ロジックがAdobe Campaignによって適用されていることを保証します(自動応答および許可/ブロックリスト)。 そうでない場合は、MTAログでエラーメッセージを検索します。

* 自動返信が有効な場合は、`SUBMIT_SM`がプロバイダーに送信されたことを確認します。 見つからない場合は、MTAログでエラーメッセージが必ず見つかります。

* 応答を含む`SUBMIT_SM MT PDU`がトレースに見つかったが、SMSが携帯電話に届かない場合は、トラブルシューティングに関してプロバイダに問い合わせる必要があります。

## 配信の準備中に、検疫済み受信者（自動応答機能によって検疫済み）を除外しない問題{#issue-delivery-preparation}

* 電話番号の形式が、強制隔離テーブルと配信ログで完全に同じであることを確認します。  それ以外の場合は、この[セクション](../../administration/using/sms-protocol.md#automatic-reply)を参照してください。

* 短いコードを確認します。 受信者の短いコードが外部アカウントで定義されているのと同じ場合、または空の場合（空の場合はショートコード）に除外が発生する可能性があります。 Adobe Campaignインスタンス全体に短いコードを1つだけ使用すると、すべての&#x200B;**短いコード**&#x200B;フィールドを空にした方が簡単です。

## エンコードの問題{#encoding-issues}

**手順1:プロバイダと連絡を取る**

問い合わせて、問題を調べます。 問題がAdobe Campaign側にあるか、または問題側にあるかを知ることができます。 問題がAdobe Campaignにある場合は、どのフィールドが正しくないかを正確に伝えることができるはずです。

**手順2:メッセージの内容**

Unicodeでは、類似した文字に対して多くのバリエーションが使用でき、Adobe Campaignではすべてを処理できません。

最も一般的な問題の原因は、ワードプロセッサーからのコピー&amp;ペーストです。このペーストは、通常の文字を、誤字に合った正しいバージョンに変更します。スペースは改行しないスペースに変更され、重複の引用符は開始引用符と終了引用符に変更され、マイナス記号は様々なハイフンに変更されました。

テスト時にメッセージをコピー&amp;ペーストしないで、常にインターフェイスに直接入力してください。

16進数を使用すると、類似する文字の違いが分かります。 小文字のL、大文字のI、O、0、すべてのタイプの引用符、非ラテンエンコーディング、さらには異なるタイプのスペースは、すべて同じように見える場合や、まったく表示されない場合があります。

Unicodeを16進数に変換するには、[Unicodeコードコンバーター](https://r12a.github.io/app-conversion/)のWebサイトなどのオンラインツールを使用できます。 テキストを入力し、電話番号などのPIIがないことを確認して、「**Convert**」をクリックします。 下部に16進値（UTF-32ゾーン）が表示されます。

エンコードの問題に関するチケットを開く際、プロバイダやAdobe Campaignのサポートの有無にかかわらず、入力内容と表示内容の16進バージョンを必ず含めます。

**手順3:何を送信すべきかを知る**

使用するエンコーディングを決定し、その文字テーブルをオンラインで検索します。 送信する文字がターゲットコードページで実際に使用できることを確認します。 `data_coding`フィールドが正しく、ユーザーとプロバイダーの予想と一致していることを確認します。

**手順4:実際に送信した内容を知る**

プロバイダに送信するバイトを正確に確認するには、コネクタのデバッグ出力が必要です。 エンコードの問題は`SUBMIT_SM PDU`に現れるので、必ずそれらを取り込んでください。 ログ内で見つけやすい非常に明確なメッセージを送信します。

テスト時に異なる種類の特殊文字を送信します。 例えば、GSM7エンコーディングには、16進形式で非常に異なる拡張文字が含まれているので、他のエンコーディングでは出現しないので、見分けが容易です。

## SMSの問題に関する通信時に含める要素{#element-include}

SMSの問題に関して、Adobe Campaign、SMSプロバイダ、またはこの問題に関する情報を開く際に、SMSの問題に関してサポートを求める場合は、次の情報を含めて、問題が適切に認定されるようにする必要があります。 適切な条件を満たした問題が、問題をより早く解決するための鍵となります。

* **問題が発生した場合に、詳細なSMPP** メッセージを有効にします。ほとんどのSMS問題は、これなしでは解決できません。

* 問題がSMSトラフィックに関連している場合は、まずプロバイダに問い合わせてください。 このプラットフォームは、SMSトラフィックの問題をリアルタイムで効率的に診断するのに最適です。

* 問題の簡単で事実に即した説明を含めます。

* 期待される結果の説明を含めます。

* プロバイダーからのフィードバックを含めます。

* 関連するログやネットワークキャプチャを含める。 キャプチャを実行する場合は、キャプチャ中に問題を再現してください。

* ログ、トレース、またはキャプチャを含める場合、問題が発生したときにファイル内の正確な場所を特定します。

* メッセージ、PDU、ログを参照する場合は、見つけやすいようにタイムスタンプを明確に記述してください。

* テスト環境で問題を再現してみてください。 設定が不明な場合は、テスト環境で試して、SMPPトレースの結果を確認してください。 通常、実稼働環境で直接レポートの問題を発生させるよりも、テスト環境でレプリケートされた問題を報告する方が効果的です。

* プラットフォームで行った変更やツイークを含めます。 また、プロバイダ側で行った可能性のある変更も含めます。

### ネットワークキャプチャ{#network-capture}

ネットワークキャプチャは必ずしも必要とは限りません。通常は、詳細なSMPPメッセージで十分です。 次に、ネットワークの取得が必要かどうかを判断する際に役立つガイドラインを示します。

* 接続に問題がありますが、詳細メッセージには`BIND_RESP PDU`が表示されません。

* エラーメッセージのない不明な接続。低レベルのプロトコルエラーを検出した場合のコネクタの通常の動作。

* プロバイダは、バインド解除/切断プロセスに関して不満を持っています。

* オプションのTLVフィールドでのエンコードの問題。

* トラフィックが異なる接続間で混在している疑いがあります。

その他の状況では、詳細なSMPPメッセージを最初に分析し、詳細ログに情報がないことが明確である場合にのみ、ネットワークキャプチャを要求してください。

場合によっては、ネットワークトラフィックを捕捉する必要がなくなります。 最も一般的な状況を次に示します。

* TLSが有効：定義上、TLSトラフィックは暗号化され、取り込めなくなります。

* パフォーマンスの問題：ログには、パフォーマンスの問題を追跡するために必要なすべての情報が含まれます。

* タイミングの問題（`retry timing`、`enquire_link`期間、スループットの上限など）

* SR解析と処理：詳細ログは、より多くのコンテキストを提供し、より適切な表示を提供します。

* MO処理(自動応答、強制隔離)

* 実際のSMPPトラフィックが関係しないエラー：配信の準備、Message Center APIの問題、ワークフローの問題など

## SMPPトレースを有効にする{#enabling-smpp-traces}

新しいコネクタは、次のトレースを介した拡張ログをサポートします。SMPP トレースは、標準出力ではなく、MTAログに出力されます。

**外部アカウントごとの有効化（推奨される方法）**

1. **外部アカウント**&#x200B;で、**ログファイル**&#x200B;の詳細SMPPトレースを有効にするを選択します。
1. 保存すると、コネクタはトレースを有効にして再接続します。

**オンザフライでの有効化**

Adobe Campaign StandardMTAにはHTTP制御インターフェイスが備わっており、その場でトレースフィルタを変更できます。
POST呼び出しは、トレースを有効/無効にできます。 SMPPトレースを有効にするURLの例：

```
POST http://host:7780/mta/trace?filter=SMPP
```

トレースを無効にするには、空のフィルターを設定します。

```
POST http://host:7780/mta/trace?filter=
```

**設定での有効化**

`config-instance.xml`ファイルで、次のパラメーターを設定します。

```
<mta args="-tracefilter:SMPP"/>
```

## コンテナ{#open-connections}上のオープン接続数の確認

コンテナ上で開いている接続の数を確認するには、次のコマンドを使用します。

```
(for pid in $(ss -neopts  | sed -n ‘s/^.*:3600[ \t].*users:(([0-9A-Za-z”]*,pid=\([0-9]*\),.*$/\1/p’ | sort ); do  cat /proc/$pid/cmdline; echo  ” $pid” ;done;) | uniq --count
```

これは、特定のポートに対して開かれた接続数をリストします。 ここでは、ポート3600を使用しています。

結果は次のようになります。

```
4 nlserversms -noconsole -tracefile:sms@INSTANCE_NAME -instance:INSTANCE_NAME -detach 15180
2 nlservermtachild -tracefile:mtachild@INSTANCE_NAME -instance:INSTANCE_NAME -detach 1838
2 nlservermtachild -tracefile:mtachild@INSTANCE_NAME -instance:INSTANCE_NAME -detach 24025
2 nlservermtachild -tracefile:mtachild@INSTANCE_NAME -instance:INSTANCE_NAME -detach 24029
2 nlservermtachild -tracefile:mtachild@INSTANCE_NAME -instance:INSTANCE_NAME -detach 29088
2 nlservermtachild -tracefile:mtachild@INSTANCE_NAME -instance:INSTANCE_NAME -detach 30390
```

smsプロセスの接続が4つ、mta子あたり2つ、子が5つ。
